---
title: "Week 4: R Packages"
output:
  html_document:
    toc: true
    include:
      after_body: footer.html
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Organizing your R code into a package
This week I will discuss how to make an R package. R packages are not just for work that you share with others. Most of my code projects are organized into an R package and definitely any project that I have that involves data and code is organized into an R package. The package framework really helps you write robust code and well documented code. It also makes it easy to bundle data with code. Organizing your code into an R package is very, very easy. If you are at the stage where you write functions and multiple R scripts for your projects, you need to be aware of how to package your code because it is such a powerful (and common) code organization method in R. By the end of this session, you will be able to build your own mini R package. I'll show you how to host it on GitLab or GitHub with a nice little landing page.

If/when you want to go into R packaging in more depth, see Hadley Wickham's book [R Packages](http://r-pkgs.had.co.nz/).

## Why a package?

An R package is an easy and the standard way to organize your R code, document your code, and share your code with other people.  Why use an R package rather than just make a bunch of scripts?

* **Reproducibility and documentation**  In the long-run, you will save yourself much work if you organize and document your code.  Rather than writing a series of scripts that you copy and alter for each project, you think about how to make your scripts into functions.
* **You want to share your code**  If you are making code to that can be used for different data, rather than only your specific problem, then you want to make a package so that you can share your code.
* **You want to make an application**  If you want to make a shiny application, having your code in a package will help.

## Set-up

**Windows users**: You might need to install [RTools](https://cran.r-project.org/bin/windows/Rtools/). Note there is a different RTools for R 4.0.0 (released in April 2020) versus earlier R releases. Look for the little link for earlier versions of RTools if you don't have 4.0.0 installed. Technically, it says you only need RTools to install packages with C/C++ so you might be fine. Personally, I always install RTools on my Windows machines since I install packages with C/C++ sometimes. But to keep things simple, try building a package without RTools and see if it works.  Mac users, don't need anything.

### Making your first package

1. Open RStudio
2. In the upper right hand corner, click the blue cube with R, and click New Project.
3. Click 'New Directory' and choose R package.
4. Give your package a name and select the directory where to put it. 
5. Click Create Package. That's it. You have created an R package.

## Make a package

1. Open RStudio
2. In the upper right hand corner, click the blue cube with R, and click New Project.
3. Click 'New Directory' and choose R package.
4. Name your package `MyNewPackage` and select the directory where to put it. 
5. Click Create Package.
6. Click on the 'Build' tab in the upper right, and click 'Install and Restart'.  Your package should build and load.

## Parts of an R package

### The essentials

2 files and a directory.

* **DESCRIPTION** This file has the meta-data about your package.  Name and what packages it depends on.  Most of it is self-explanatory.  The `Imports:` is any functions from other packages that you use.

* **NAMESPACE** This file indicates what needs to be exposed to users for your R package. For our course, you won't need to edit as devtools takes care of it.

* **R directory** This is where all your R code goes for your package.

### Basic add-ons

* **man** A directory for documentation.  You won't need to write this.  It will be added automatically.

* **data** A directory for data files saved in RData format (with the ending `.RData`)


## Using and adding stuff

You have built this package and loaded it.  You can use the package functions.  Type 

```
hello()
```

### Add a new function

1. Create a new R script. Call it `littleforecast.R` and save in the R directory.

```
littleforecast <- function(data, nyears=10){
  fit <- forecast::auto.arima(data)
  fc <- forecast::forecast(fit, h = nyears)
  ggplot2::autoplot(fc)
}
```

2. Open NAMESPACE. and Paste in 

```
export(littleforecast)
```

3. Open DESCRIPTION. Under Description, paste these lines

```
Depends: R (>= 3.4.1), ggplot2
Imports: forecast
```

4. Click Install and Restart from the build tab.


### Use your new function

```
dat <- WWWusage
littleforecast(dat, nyears=100)
```

and a 100 year forecast of internet usage should appear.

## Add data

1. Add a folder called `data`

2. Run these lines from the command line.

```
WWW2 <- WWWusage^2
save(WWW2, file="data/WWW2.RData")
```

3. Click Install and Restart from the Build tab

4. Now your data is available from your package. Type 

```
WWW2
littleforecast(WWW2)
```
at the command line.

## The key components

### The DESCRIPTION file

Open the file named DESCRIPTION.  Most of it is self-explanatory.  `Depends:` means the user will have all the commands of that package at the command line. `Imports:` is any other R packages that your package needs in order to work but it's functions won't be available at the command line (unless you choose).

```
Package: MyNewPackage
Type: Package
Title: What the Package Does (Title Case)
Version: 0.1.0
Author: Who wrote it
Maintainer: The package maintainer <yourself@somewhere.net>
Description: More about what it does (maybe more than one line)
    Use four spaces when indenting paragraphs within the Description.
Depends: R (>= 3.4.1), ggplot2
Imports: forecast
License: What license is it under?
Encoding: UTF-8
LazyData: true
```

### The NAMESPACE file

This is commands to export functions (in the R folder) to the command line for use. If you don't have a function here, the user will need to use `:::` to access the function.

```
exportPattern("^[[:alpha:]]+")
export(littleforecast)
```

The first line means "export all functions". I don't normally have that line. The next line is exporting the `littleforecast` function.

### The R Directory: Function code

This is where functions are put.  Each file is a separate function.  You can put multiple functions in one file, but that can get confusing unless they are small functions.

It has this structure: name and the names of information passed into the function.

```
functionname <- function(infofunctionneeds1, infofunctionneeds2, ...){
# The work
return(<what you want to return to user>)
}
```

<!---

### Function documentation

Now look at the top of `myarimaforecast.R`.  This is the function documentation.  It describes what the function does.  See `SSTplot()` for another example.  Here is the structure of the documentation:

```
#' Briefly What Does Your Package Do
#'
#' Longer description of what your package does.  This is about a paragraph in length.
#'
#' @param function_argument describe what the argument is
#' @param function_argument2 add as many @param's as you need
#' @return What does your function return or do?
#' @examples
#' add some working R code that shows how to use your function
#' @export
```

`@export` means that your function is not hidden.  Just include this for now.

Updating the documentation.  By default, RStudio does not remake the documentation when you click 'Build & Reload'.  You can change that by going to Tools > Project Options > Build Tools and then clicking 'Configure' next to 'Generate documentation with Roxygen' and then clicking the box next to 'Build & Reload'.  Or you can run the code:

```
devtools::document()
```

-->

## Sharing your package

You can put your package on GitLab or GitHub and then people can easily install it. Yes, you could share a zip file...

Note: Each time you change your package, you should update the version so that people know which version they are using.


### GitHub Desktop Instructions

** You have not made your folder a Git repository yet

* Open GitHub Desktop.  
* Click New Repository and then type in 'MyNewPackage' (or whatever you named your new package).
* Click Publish (to GitHub)

** You have made your folder a Git repository already

* Open GitHub Desktop.  
* Click Add Local Repository... and then type in 'MyNewPackage' (or whatever you named your new package).
* Click Publish (to GitHub)

Go to your GitHub account (online) and you will see your repository there.

### RStudio Instructions

For GitHub or GitLab.

1. Open RStudio and make sure `MyNewPackage` (or whatever you named your new package) shows up in the upper right corner.
2. Click Tools > Version Control > Project Setup and select Git in the drop down. Click Create Repository.
3. Open GitLab or GitHub.
4. Create a blank repository with the name `MyNewPackage` (or whatever you named your new package). Don't add anything to it.
5. Copy the URL of that new repository.
6. Go back to RStudio. Click on the Git tab. 
7. Commit all your new changes (those files we added and such)
8. Click the cog and select "Shell".
7. Type these lines to the command line. Note URL is the URL you copied above.
```
git remote add URL
git push -u origin master
```

Note, I don't actually do it this way because I often mess things up and it's too many steps to remember. I create a new project with that URL (New Project > Version Control > URL) and then manually copy my files into the new repository folder.


## Installing from GitHub/Lab

The code you will use to install from GitHub is:

```
library(devtools)
install_github("youraccount/MyNewPackage")
```

or

```
library(devtools)
install_gitlab("youraccount/MyNewPackage")
```

For example to install the package on 'RVerse-Tutorials', you would use
```
install_github("RVerse-Tutorials/TestPackage")
```

## More on GitHub/Lab

### Landing page

Why? It looks nicer and conveys the needed info to users. This is for GitHub. I haven't done this on GitLab.

1. In RStudio in your `MyNewPackage`, create a new text file called `README.md` and type in some info about your package.
2. Push the new file to GitHub.
3. Open repo on GitHub, Click Settings, Scroll down to GitHub Pages, Select Source and select "master". Select a theme.
4. Wait a few minutes and then go to the URL shown.

### **pkgdown**

I am actually switching to [pkgdown](https://pkgdown.r-lib.org/articles/pkgdown.html) for my landing pages for more developed products.

### Making releases

Make a release on GitHub (tag on GitLab)

To install the latest release

```
install_github("youraccount/MyNewPackage@*release")
```


## Debugging Tools

### Entering functions

This is an personal list of some simple degugging tools. Also I am not familiar with the debugging tools in RStudio.

```
debug(function)
undebug(function)
```

Allows you to go line by line through the function and interact at the command line.

`browser()`

Put in your code where you want to enter the function. 

`options(error=recover)`

Puts you into browser() at the point of the error (instead of a specific spot)

`traceback()`

Tells you where your code stopped. Note RStudio will show this also. Check your Project Options under Tools if you don't see Traceback on errors.

### How long?

`system.time( function )`

How long does it take?

**Profiling**

`Rprof()` and `summaryRprof()`

Profile your code to find out what are the time hogs.

```{r}
a=matrix(0,10,100)
Rprof(tmp<-tempfile())
for(i in 1:10000){ b=t(a)%*%a }
Rprof()
summaryRprof(tmp)
```

**microbenchmark**


## Styling

**styler** package


